{% extends 'base.html' %}
{% load static %}

{% block title %}
 Noora Kids Shop
{% endblock %}

{% block content %}
{% include 'header.html' %}    
        <div class="breadcrumb-area bg-gray">
            <div class="container">
                <div class="breadcrumb-content text-center">
                    <ul>
                        <li>
                            <a href="{% url 'home' %}">Home</a>
                        </li>
                        <li class="active">Products: {{slug}} </li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="shop-area pt-80 pb-120">
            <div class="container">
                <div class="row flex-row-reverse">
                    <div class="col-lg-12">
                        <div class="shop-topbar-wrapper">
                            <div class="shop-topbar-left">
                                <div class="view-mode nav">
                                    <a class="active" href="#shop-1" data-toggle="tab"><i class="icon-grid"></i></a>
                                    <a href="#shop-2" data-toggle="tab"><i class="icon-menu"></i></a>
                                </div>
                                <p>Showing 1 - 20 of 30 results </p>
                            </div>
                            <div class="product-sorting-wrapper">
                                <div class="product-shorting shorting-style">
                                    <label>View :</label>
                                    <select>
                                        <option value=""> 20</option>
                                        <option value=""> 23</option>
                                        <option value=""> 30</option>
                                    </select>
                                </div>
                                <div class="product-show shorting-style">
                                    <label>Sort by :</label>
                                    <select>
                                        <option value="">Default</option>
                                        <option value=""> Name</option>
                                        <option value=""> price</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="shop-bottom-area">
                            <div class="tab-content jump">
                                <div id="shop-1" class="tab-pane active">
                                    <form action="{% url 'cart' %}">
                                        {% csrf_token %}
                                    <div class="row" id="products_data">
                                        
                                            
                                        
                                    </div>
                                </form>
                                </div>
                            </div>
                            <div class="pro-pagination-style text-center mt-10">
                                <ul>
                                    <li><a id="prev" class="prev" href="#"><i class="icon-arrow-left"></i></a></li>
                                    <li><a id="page" class="active" href="#">1</a></li>
                                    <li><a id="next" class="next" href="#"><i class="icon-arrow-right"></i></a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% include 'footer.html' %}
    <script>
        window.onload= function() {
            let params = (new URL(document.location)).searchParams;
            let page = params.get("page");
            let url =""
            
            if (page!=null && parseFloat(page) == page){
                const base_url = window.location.href.split("?page=").at(-2);
                document.getElementById("page").innerHTML=page
                document.getElementById('next').href=`${base_url}?page=${+page+1}`;
                if (page>1){
                    document.getElementById('prev').href=`${base_url}?page=${+page-1}`;
                }
                url =base_url+'api/v1/?page='+page;
                
            }else{
                if (page!=null && parseFloat(page) != page) {
                    const base_url = window.location.href.split("?page=").at(-2);
                    window.location.href =base_url;
                }else{
                url ='api/v1/';
                document.getElementById('next').href=`${ window.location.href}?page=2`;
                document.getElementById('prev').href='javascript: void(0)'
                }
            }
            fetch(url,{
                method:'GET',
            })
            .then(
                response=>{
                    if (response.ok){
                        return response.json();
                    }
                    else  {
                        throw new Error('not connected');
                    }
                }
            )
            .then((data) => {
                
                let products = data.results;
                let main_div=document.getElementById("products_data")
                products.map(function(product) {
                    let div1 = document.createElement('div');
                    div1.classList.add('col-xl-4', 'col-lg-4', 'col-md-6' ,'col-sm-6', 'col-12');
                    
                    let div2 = document.createElement('div');
                    div2.classList.add('single-product-wrap', 'mb-35');
                    
                    let img = document.createElement('img');
                    img.classList.add('product-img',  'product-img-zoom','mb-15');
                    img.src=product.images[0].image
                    img.alt='product_image'
                    img.style.maxHeight='360px'
                    img.style.maxWidth='360px'
                    div2.appendChild(img); 
                    
                    let div3=document.createElement('div');
                    div3.classList.add("product-content-wrap2", "text-center");
                    let title=document.createElement('h3');
                    let a=document.createElement('a');
                    a.href=`/product/${product.slug}`
                    a.innerHTML=product.title
                    title.appendChild(a)
                    div3.appendChild(title)
                    
                    let div4=document.createElement('div');
                    div4.classList.add("product-price-2");
                    let span= document.createElement('span');
                    span.innerHTML=product.price + '$'
                    div4.appendChild(span)
                    div3.appendChild(div4)
                    
                    let div5=document.createElement('div');
                    div5.classList.add("pro-add-to-cart");
                    let button= document.createElement('button');
                    button.innerHTML="Add To Cart"
                    button.title="Add to Cart"
                    button.setAttribute("onclick",`add_to_cart(${product.id})`);
                    div5.appendChild(button)
                    div3.appendChild(div5)
                    
                    div2.appendChild(div3)
                    div1.appendChild(div2);
                    main_div.appendChild(div1)
                    
                    if (!data.next){
                        document.getElementById('next').href='javascript: void(0)'
                    }
                });
                
                })
            .catch(function(error) {
                console.log(error);
            });                    
        }
        
        function add_to_cart(product_id){
            const url = '/cart/api/v1/add/'
            console.log(product_id)
            console.log(JSON.stringify({ product_id: product_id }))
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            fetch(url,{
                method:'POST',
                body:JSON.stringify({ product_id: product_id }),
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                    'Authorization':`Bearer ${window.localStorage.getItem("access_token")}`,
                }
            })
            .then(
                response=>{
                    if (response.ok){
                        return response.json();
                    }
                    else  {
                        throw new Error('not connected');
                    }
                }
            )
            .catch(function(error) {
                console.log(error);
            });
        }
    </script>
        {% endblock %}
