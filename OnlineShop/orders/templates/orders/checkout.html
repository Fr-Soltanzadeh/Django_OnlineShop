
{% extends 'base.html' %}
{% load static %}

{% block title %}
 Checkout
{% endblock %}

{% block content %}
{% include 'header.html' %}

    <div class="main-wrapper">

        <div class="breadcrumb-area bg-gray">
            <div class="container">
                <div class="breadcrumb-content text-center">
                    <ul>
                        <li>
                            <a href="{% url 'home' %}">Home</a>
                        </li>
                        <li class="active">Checkout </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="checkout-main-area pt-80 pb-120">
            <div class="container">
                <div class="customer-zone mb-20">
                    <p class="cart-page-title">Have a coupon? <a class="checkout-click3" href="#">Click here to enter your code</a></p>
                    <div class="checkout-login-info3">
                        <form action="#">
                            <input type="text" placeholder="Coupon code">
                            <input type="submit" value="Apply Coupon">
                        </form>
                    </div>
                </div>
                
                <div class="checkout-wrap pt-30">
                    <div class="row">
                        <div class="col-lg-7">
                            <div class="billing-info-wrap mr-50">
                                <h3>Billing Details</h3>
                                <div class="row mt-3">
                                    <div class="col-lg-6 col-md-6">
                                        <div class="billing-info mb-20">
                                            <label>Reciever Fullname</label>
                                            <input type="text" name="receiver_fullname">
                                        </div>
                                    </div>
                                    
                                    <div class="col-lg-6 col-md-6">
                                        <div class="billing-info mb-20">
                                            <label>Reciever Phone Number</label>
                                            <input type="text" name="receiver_phone_number">
                                        </div>
                                    </div>
                                </div>
                                <div id="addresses">

                                </div>
                                
                                <div class="checkout-account mt-40">
                                    <input class="checkout-toggle" type="radio" name="flexRadioDefault">
                                    <span>Add a new address to ship?</span>
                                </div>
                                <div class="different-address open-toggle mt-30">
                                    <form action="javascript: void(0)" method="post" style="width:  100%;" onsubmit="post_address()" id="add_address">
                                        {% csrf_token %}
                                    <div class="row">
                                        
                                            
                                        <div class="col-lg-6 col-md-6">
                                            <div class="billing-info mb-20">
                                                <label>Province</label>
                                                <input type="text" name="province">
                                            </div>
                                        </div>
                                        <div class="col-lg-6 col-md-6">
                                            <div class="billing-info mb-20">
                                                <label>City / Town</label>
                                                <input type="text" name="city">
                                            </div>
                                        </div>
                                        <div class="col-lg-6 col-md-6">
                                            <div class="billing-info mb-20">
                                                <label>Street</label>
                                                <input type="text" name="street">
                                            </div>
                                        </div>
                                        <div class="col-lg-6 col-md-6">
                                            <div class="billing-info mb-20">
                                                <label>Postcode</label>
                                                <input type="text" name="postal_code">
                                            </div>
                                        </div>
                                        <div class="col-lg-12">
                                            <div class="billing-info mb-20">
                                                <label>Address detail</label>
                                                <input type="text" name="address_detail">
                                            </div>
                                        </div>
                                        
                                            <input type="submit" value="Place address">

                                    </div>
                                </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-5">
                            <div class="your-order-area">
                                <h3>Your order</h3>
                                <div class="your-order-wrap gray-bg-4">
                                    <div class="your-order-info-wrap">
                                        <div class="your-order-info">
                                            <ul>
                                                <li>Product <span>Total</span></li>
                                            </ul>
                                        </div>
                                        <div class="your-order-middle">
                                            <ul id="items">
                                                
                                            </ul>
                                        </div>
                                        <div class="your-order-info order-subtotal">
                                            <ul>
                                                <li >Subtotal <span id="Subtotal"> </span></li>
                                            </ul>
                                        </div>
                                        <div class="your-order-info order-total">
                                            <ul>
                                                <li>Your profit from purchase<span id="profit"></span></li>
                                            </ul>
                                        </div>
                                        <div class="your-order-info order-shipping">
                                            <ul>
                                                <li>Shipping <span id="Shipping"> </span>
                                                </li>
                                            </ul>
                                        </div>
                                        
                                        <div class="your-order-info order-total">
                                            <ul>
                                                <li>Total <span id="Total"></span></li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="payment-method">
                                        <div class="pay-top sin-payment">
                                            <input id="payment_method_1" class="input-radio" type="radio" value="cheque" checked="checked" name="payment_method" required>
                                            <label for="payment_method_1"> Direct Bank Transfer </label>
                                            <div class="payment-box payment_method_bacs">
                                                <p>Make your payment directly into our bank account. Please use your Order ID as the payment reference.</p>
                                            </div>
                                        </div>
                                        <!-- <div class="pay-top sin-payment sin-payment-3">
                                            <input id="payment-method-4" class="input-radio" type="radio" value="cheque" name="payment_method">
                                            <label for="payment-method-4">PayPal <img alt="" src="{% static 'assets/images/icon-img/payment.png'%}"><a href="#">What is PayPal?</a></label>
                                            <div class="payment-box payment_method_bacs">
                                                <p>Make your payment directly into our bank account. Please use your Order ID as the payment reference.</p>
                                            </div>
                                        </div> -->
                                    </div>
                                </div>
                                <div class="Place-order">
                                    <a href="#">Proceed to pay</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% include 'footer.html' %}

    <script>
        window.onload=function(){
            const url ="/cart/api/v1/"
            fetch(url,{
                method:'GET',
                headers:{
                    'Authorization':`Bearer ${window.localStorage.getItem("access_token")}`
                }
            })
            .then(
                response=>{
                    if (response.ok){
                        return response.json();
                    }
                    else  {
                        if (response.status==401){
                            refresh_token(location.href)
                        }else{
                            throw new Error('not connected');
                        }
                    }
                }
            )
            .then((data) => {
                
                load_address(data.customer.addresses)
                load_order(data)
                })
            .catch(function(error) {
                console.log(error);
            });   
            function load_address(data){
                addresses=document.getElementById('addresses')
                data.forEach(address => {
                    let div=document.createElement('div')
                    div.classList.add("mt-3","form-check")
                    let input=document.createElement('input')
                    input.classList.add("form-check-input")
                    input.type="radio"
                    input.name="flexRadioDefault"
                    input.value=data.id
                    input.checked="checked"
                    let span=document.createElement('span')
                    span.innerText=`${address.province}, ${address.city}, ${address.street}, ${address.detail}, ${address.postal_code}`
                    div.appendChild(input)
                    div.appendChild(span)
                    addresses.appendChild(div)
                });
            }   
            function load_order(data){
                console.log(data)
                document.getElementById("Subtotal").innerHTML=`$${data.total_price}`
                const shipping=2
                document.getElementById("Shipping").innerHTML=`$${shipping}`
                document.getElementById("profit").innerHTML=`$${Number(data.total_price)-Number(data.grand_price)}`
                document.getElementById("Total").innerHTML=`$${Number(data.grand_price)+Number(shipping)}`
                const cartItems=data.cart_items
                let items = document.getElementById("items")
                cartItems.forEach(item=>{
                    li = document.createElement("li")
                    li.innerHTML=`Product ${item.product.title} X ${item.quantity}`
                    span=document.createElement("span")
                    span.innerHTML=`$${item.product.price}`
                    li.appendChild(span)
                    items.appendChild(li)                    
                })
            }                  
        }
        function post_address(){
            const url = "/user_address/api/v1/"
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const form = document.getElementById("add_address");
            const formData = new FormData(form);
            
            for (let pair of formData.entries()) {
        console.log(pair[0] + ": " + pair[1]);
    }
            fetch(url,{
                method:'POST',
                body: formData,
                headers:{
                    'X-CSRFToken': csrftoken,
                    'Authorization':`Bearer ${window.localStorage.getItem("access_token")}`,
                }
            })
            .then(
                response=>{
                    if (response.ok){
                        return response.json();
                    }
                    else  {
                        if (response.status==401){
                            refresh_token("/login/",post_address)
                        }else{
                            throw new Error('not connected');
                        }
                    }
                }
            )
            .then((data) => {
               location.reload()
                })
            .catch(function(error) {
                console.log(error);
            });   

        }
            
    
    </script>
    {% endblock %}
    